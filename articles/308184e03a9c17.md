---
title: "[brew update]Error:homebrew-core is a shallow clone.ã§å¤±æ•—ã™ã‚‹ã®ã‚’è§£æ±º"
emoji: "ğŸ”§"
type: "tech"
topics: ["git", "github", "homebrew"]
published: true
---

![](https://storage.googleapis.com/zenn-user-upload/sd6mbsdseqv7b516rk2vvbx0xtk3)

## å‰æ

ã‚¿ã‚¤ãƒˆãƒ«é€šã‚Š`brew update`ã‚’ã—ã‚ˆã†ã¨ã™ã‚‹ã¨homebrew-coreãŒshallow cloneã ã¨å‡ºã¦å‹•ã‹ãªã‹ã£ãŸã€‚
ã‚¨ãƒ©ãƒ¼æ–‡ã®è§£é‡ˆã¨è§£æ±ºæ–¹æ³•ã«ã¤ã„ã¦ã®ãƒ¡ãƒ¢ã¾ã¨ã‚ãŸã®ã§ä»¥ä¸‹ã«è¼‰ã›ã¦ã„ãã€‚
â€»ç­†è€…ã‚‚å‹‰å¼·ä¸­ã®ãŸã‚é–“é•ã„ãŒã‚ã‚Šã¾ã—ãŸã‚‰ã”æŒ‡æ‘˜ã„ãŸã ã‘ã‚‹ã¨å¹¸ã„ã§ã™ï¼

### Homebrewã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³

```
$ brew --version
Homebrew 2.6.1
Homebrew/homebrew-core (git revision 6ba53; last commit 2020-12-09)
Homebrew/homebrew-cask (git revision 02bd60; last commit 2020-12-10)
```

### ç™ºç”Ÿäº‹è±¡

`brew update`ã‚’ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ä¸‹è¨˜ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—å‡ºæ¥ãªã„ã€‚

```jsx
$ brew update
Error: homebrew-core is a shallow clone. To `brew update` first run:
git -C "/usr/local/Homebrew/Library/Taps/homebrew/homebrew-core" fetch --unshallow
This restriction has been made on GitHub's request because updating shallow
clones is an extremely expensive operation due to the tree layout and traffic of
Homebrew/homebrew-core. We don't do this for you automatically to avoid
repeatedly performing an expensive unshallow operation in CI systems (which
should instead be fixed to not use shallow clones). Sorry for the inconvenience!
```

## ã‚¨ãƒ©ãƒ¼ã‚’è§£æ±º

ã“ã“ã¾ã§èª­ã‚“ã§ã€Œç†å±ˆã¯ã¨ã‚‚ã‹ãæ—©ãæ²»ã—ãŸã„ï¼ã€ã¨è¨€ã†æ–¹ã¯**ã‚¨ãƒ©ãƒ¼æ–‡ã«ã‚ã‚‹é€šã‚Šä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã¦ã°è§£æ±º**ã§ã™ã€‚

```
-- æ™‚é–“ã‹ã‹ã‚‹...
$ git -C "/usr/local/Homebrew/Library/Taps/homebrew/homebrew-core" fetch --unshallow
```

## ã‚¨ãƒ©ãƒ¼ã®è§£é‡ˆ

> homebrew-core is a shallow clone. To `brew update` first run

ã€homebrew-coreã¯shallow cloneã§ã™ã€‚å…ˆã«(ä¸‹è¨˜ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’)èµ°ã‚‰ã›ã¦ãã ã•ã„ã€‚ã€ã¨ã‚ã‚Šã¾ã™ã€‚

shallow cloneã¨ã¯Gitã®æ©Ÿèƒ½ã§ã“ã‚Œã‚’ä½¿ãˆã°æœ€æ–°ç‰ˆã®ã‚³ãƒŸãƒƒãƒˆã®ã¿pull[^1]ã—ã¦æ¥ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚

(ã‚ˆã‚Šæ­£ç¢ºã«è¨€ãˆã°ä»»æ„ã®æ·±ã•(ãƒãƒ¼ã‚¸ãƒ§ãƒ³)ã®æ‰€ã¾ã§pullå‡ºæ¥ã‚‹æ©Ÿèƒ½ã§ã™ã€‚)

â€»å‚è€ƒï¼š[How to Use Git Shallow Clone to Improve Performance](https://www.perforce.com/blog/vcs/git-beyond-basics-using-shallow-clones#:~:text=Git%20shallow%20clone%20lets%20you,a%20particular%20depth%20to%20pull)

> This restriction has been made on GitHub's request because updating shallow
clones is an extremely expensive operation due to the tree layout and traffic of
Homebrew/homebrew-core.

ç¶šãã¾ã™ã€‚ã€ã“ã®åˆ¶é™ã¯GitHubã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚ˆã‚‹ã‚‚ã®ã§ã™ã€‚ã¨ã„ã†ã®ã‚‚shallow cloneã®å®Ÿè¡Œã¯ãƒ„ãƒªãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚„Homebrew/homebrew-coreã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯é‡ã‚’è€ƒãˆã‚‹ã¨ã‹ãªã‚Šã®é«˜ã‚³ã‚¹ãƒˆãªå‡¦ç†ã«ãªã£ã¦ã—ã¾ã†ãŸã‚ã§ã™ã€‚ã€

ã“ã“ã‹ã‚‰shallow cloneãŒãƒ€ãƒ¡ã«ãªã£ãŸã®ã¯GitHubã‹ã‚‰ã®è¦è«‹ãªã®ã ã€ã¨ç†è§£ã§ãã¾ã™ã€‚

ã“ã‚Œã«ã¤ã„ã¦ã¯[Why shallow clone is expensive to perform?](https://github.com/Homebrew/discussions/discussions/225)ã¨ã„ã†GitHub Discussionå†…ã«æŒ™ã’ã‚‰ã‚Œã¦ã„ã‚‹[ãƒªãƒ³ã‚¯](https://github.com/CocoaPods/CocoaPods/issues/4989#issuecomment-193772935)å…ˆã®ä¸­ã§ã®ã‚³ãƒ¡ãƒ³ãƒˆã§ã‚ˆã‚Šè©³ç´°ã«èª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚ä¸‹è¨˜ã«ã¦ç­†è€…ãŒé‡è¦ã ã¨æ€ã£ãŸç®‡æ‰€ã®ã¿æŠœç²‹ã—ã¾ã™ã€‚

> most of the initial clones are shallow, meaning that not the whole history is fetched, but just the top commit. But then subsequent fetches don't use the --depth=1 option. Ironically, this practice can be much more expensive than full fetches/clones, especially over the long term. It is usually preferable to pay the price of a full clone once, then incrementally fetch into the repository, because then Git is better able to negotiate the minimum set of changes that have to be transferred to bring the clone up to date.

ä¸€åº¦shallow cloneã—ã¦ã‚‚å¾Œã€…ã®fetchã§(depth=1ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒä½¿ã‚ã‚Œã‚‹ã“ã¨ã¯ãªã„ã®ã§)çµå±€ãƒ‰ã‚«ãƒ³ã¨å…¨ä½“ãŒè½ã¨ã•ã‚Œã‚‹ã€‚ãã‚Œã‚ˆã‚Šã‚‚æœ€åˆã«git cloneã§ãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã‚’å–ã£ã¦ãã¦å¾ã€…ã«git fetchã§å¤‰åŒ–ã‚’åŸ‹ã‚ã¦ã„ãæ–¹ãŒGitã¯å¾—æ„ã ã—è² è·ã‚‚ä½ããªã‚‹ã¨ã®ã“ã¨ã€‚

ã•ã¦ã€æœ€å¾Œã®ã‚¨ãƒ©ãƒ¼æ–‡ã‚’èª­ã‚“ã§ã„ãã¾ã™ã€‚

>We don't do this for you automatically to avoid
repeatedly performing an expensive unshallow operation in CI systems (which
should instead be fixed to not use shallow clones). Sorry for the inconvenience!

ã€ä»Šå›ä¸Šè¨˜ã®æªç½®ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãŸã‚è‡ªå‹•çš„ã«è¡Œã‚ãªã‹ã£ãŸã®ã¯CI(ç¶™ç¶šçš„ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)ã‚·ã‚¹ãƒ†ãƒ ã®ä¸­ã§ç¹°ã‚Šè¿”ã—é«˜ã‚³ã‚¹ãƒˆãªunshallowã®å‡¦ç†ã‚’è¡Œã†ã“ã¨ã‚’é¿ã‘ã‚‹ãŸã‚ã§ã™ã€‚ã”è¿·æƒ‘ãŠã‹ã‘ã—ã¦ãŠã‚Šã¾ã™<(_ _)>.ã€

è‡ªå‹•ã§å®Ÿè¡Œã™ã‚‹ã¨é€†ã«è² è·ãŒå¤§ãã„ã‹ã‚‰æ‰‹å‹•ã§ã‚„ã£ã¦ã­ã€ã¨ã®ã“ã¨ã§ã—ãŸã€‚

## å‚è€ƒ
- [How to Use Git Shallow Clone to Improve Performance](https://www.perforce.com/blog/vcs/git-beyond-basics-using-shallow-clones#:%7E:text=Git%20shallow%20clone%20lets%20you,a%20particular%20depth%20to%20pull)
- [Why shallow clone is expensive to perform? #225 GitHuB Disccussion](https://github.com/Homebrew/discussions/discussions/225)
- [Issues Cloning Spec repo - GitHub taking a very long time to download changes to the Specs Repo #4989 GitHuB Issue](https://github.com/CocoaPods/CocoaPods/issues/4989#issuecomment-193772935)



[^1]: pullã¨ã¯ç°¡å˜ã«è¨€ã†ã¨ã€Œãƒªãƒ¢ãƒ¼ãƒˆã‹ã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚³ãƒŸãƒƒãƒˆã‚„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¼•ã£å¼µã£ã¦ã—ã‹ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ„ãƒªãƒ¼ã«ãƒãƒ¼ã‚¸ã¾ã§ã—ã¦ãã‚Œã‚‹ã€gitã®ã‚³ãƒãƒ³ãƒ‰
